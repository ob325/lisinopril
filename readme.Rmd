---
title: "Angioedema incidence after first exposure to lisinopril"
author: "William J. O'Brien" 
output: github_document
always_allow_html: true
---

# Introduction

The purpose of this research notebook is to demonstrate a reproducible program to assess the incidence rate of angioedema within 1 year of first drug exposure to lisinopril. 

# R libraries and setup 

The tangled R code of this notebook is in ./lisinoprilScript.R 

This study uses renv for reproducibility. Re-create the R library by running: 

```{r eval = FALSE}

renv::restore()

```

```{r output=FALSE, message=FALSE, warning=FALSE}

rm(list=ls())

library(DatabaseConnector)
library(SqlRender)
library(CohortGenerator)
library(Capr)
library(CohortIncidence)
library(Eunomia)
library(dplyr) 
library(DT)

cdmSchema <- "main"
cohortSchema <- "main" 
cohortTableName <- "lisinopril"

niceTable <- function(x) kableExtra::kable_styling(knitr::kable(x))

```

# Database connection 

```{r warning=FALSE, message = FALSE, results='asis'}

connectionDetails <- getEunomiaConnectionDetails()

connection <- connect(connectionDetails)

```

# Eunomia "customization" 

I am using the synthetic Eunomia CDM for testing. But there is a problem... Eunomia was designed for running the model GI bleed study and the very small concept table does not even have an entry for our target and outcome. I will hack Eunomia and insert the concept name "lisinopril" in place of diclofenac, and "angioedema" in place of gastrointestinal hemorrhage. Of course we would never mutate the data in a real CDM. 

```{r warning=FALSE, message = FALSE, results='asis'}

renderTranslateQuerySql(connection, 
                        "select * from @cdmSchema.concept 
                         where concept_name like 'diclofenac'",
                        cdmSchema = cdmSchema) |>
  niceTable()

renderTranslateQuerySql(connection, 
                        "select * from @cdmSchema.concept 
                        where concept_name like '%gastro%'",
                        cdmSchema = cdmSchema) |>
  niceTable()

```

```{r warning=FALSE, message = FALSE, results='asis', output=FALSE}

renderTranslateExecuteSql(
  connection,
  "update @cdmSchema.concept
   set concept_name = 'Lisinopril'
   where concept_id = 1124300;",
  cdmSchema = cdmSchema)

renderTranslateExecuteSql(
  connection,
  "update @cdmSchema.concept
   set concept_name = 'Angioedema'
   where concept_id = 192671;",
  cdmSchema = cdmSchema)

```

# Find standard concept ids

## Lisinopril 

My use of the SqlRender functions in these queries is so that other organizations can run it as-is without refactoring for different sql dialects

```{r warning=FALSE, message = FALSE, results='asis'}

renderTranslateQuerySql(
  connection, 
  "select * 
   from @cdmSchema.concept 
   where concept_name = 'Lisinopril'
     and domain_id = 'Drug'
     and concept_class_id = 'Ingredient'
     and standard_concept = 'S'",
  cdmSchema = cdmSchema) |>
  niceTable()

lisinoprilConcept <- 1124300

```

What are the descendants? 

I always review these to get a sense of:

- sheer number of formulations/brands we are dealing with

- did the mapping team make any mistakes?

- single vs. combo drugs

- doses or IV/intramuscula route that might indicate drug exposure in ED, as opposed to typical Rx exposure

```{r warning=FALSE, message = FALSE, results='asis'}

renderTranslateQuerySql(
  connection,
  "select descendant_concept_id, 
     concept_name descendant_concept_name
   from @cdmSchema.concept_ancestor a
   left join @cdmSchema.concept b
     on a.descendant_concept_id = b.concept_id
   where ancestor_concept_id = @lisinoprilConcept",
  cdmSchema = cdmSchema,
  lisinoprilConcept = lisinoprilConcept) |>
  niceTable() 

```

Results: there are no descendants of the target concept in Eunomia 

## Angioedema 

```{r warning=FALSE, message = FALSE, results='asis'}

renderTranslateQuerySql(
  connection, 
  "select * 
   from @cdmSchema.concept 
   where concept_name = 'Angioedema'
     and domain_id = 'Condition'
     and standard_concept = 'S'",
  cdmSchema = cdmSchema) |>
  niceTable()

angioedemaConcept <- 192671

```

Looking at Athena, I noticed there are some angioedema descendants we may want to exclude. For example, is hereditary angioedema an adverse event attributable to ACE-I? That is a decision for a clinician to make, but I will do so here for demonstration.  

```{r warning=FALSE, output=FALSE, results='asis'}

renderTranslateQuerySql(
  connection,
  "select descendant_concept_id, 
     concept_name descendant_concept_name
   from @cdmSchema.concept_ancestor a
   left join @cdmSchema.concept b
     on a.descendant_concept_id = b.concept_id
   where ancestor_concept_id = @angioedemaConcept",
  cdmSchema = cdmSchema,
  angioedemaConcept = angioedemaConcept) |>
  niceTable() 

hereditaryAngioedemaConcept <- 4307793

```

# Concept sets 

## Lisinopril 

I like to pull the concept details after creating the concept set so they are clearly labelled

```{r message = FALSE, warning = FALSE}

lisinoprilCs <- cs(descendants(lisinoprilConcept), 
                   name = 'linosoprilCs') |>
  getConceptSetDetails(connection, cdmSchema) 

lisinoprilCs 

```


## Angioedema 

```{r message=FALSE, warning=FALSE}

angioedemaCs <- cs(descendants(angioedemaConcept),
                   exclude(hereditaryAngioedemaConcept),
                   name = 'angioedemaCs') |>
  getConceptSetDetails(connection, cdmSchema)

angioedemaCs 

```

# Cohort definitions 

## Target: lisinopril 

The target cohort is people with their first drug exposure to the ingredient lisinopril. Exit is 1 year after first exposure, so they remain in the cohort whether or not they continue the medication. To have reasonable assurance it is their first exposure, I will use an attribute (in Capr-speak) to the cohort entry query that requires one year of prior continous observation. I also include an age attribute because I presume this is not a pediatric study. I would ask here if we want to exclude from the cohort anyone with prior angioedema, but the exercise does not specify so I will leave attrition as NULL. 

```{r output=FALSE, message=FALSE, warning=FALSE}

targetCohort <- cohort(
  entry = entry(drugExposure(lisinoprilCs, 
                             firstOccurrence(),
                             age(gte(18))),
                observationWindow = continuousObservation(priorDays = 365)),
  attrition = NULL,
  exit = exit(endStrategy = fixedExit(offsetDays = 365)),
  era = NULL) 

```

## Event: angioedema 

This includes all condition occurrences for the event, and one person can appear in many rows. Cohort duration is arbitrarily one day, as only the entry date matters here. 

```{r output=FALSE, message=FALSE, warning=FALSE}

eventCohort <- cohort(
  entry = entry(conditionOccurrence(angioedemaCs)),
  attrition = NULL,
  exit = exit(endStrategy = fixedExit(offsetDays = 1)),
  era = NULL) 

```

## Cohort set

```{r output=FALSE, message=FALSE, warning=FALSE}

cohortSet <- makeCohortSet(targetCohort, eventCohort)

```

# Cohort generation 

```{r output = FALSE, message = FALSE, warning = FALSE, results='hide'}

cohortTableNames <- getCohortTableNames(cohortTable = cohortTableName)

createCohortTables(connectionDetails = connectionDetails,
                   cohortDatabaseSchema = cohortSchema,
                   cohortTableNames = cohortTableNames)

generateCohortSet(connectionDetails = connectionDetails,
                  cdmDatabaseSchema = cdmSchema,
                  cohortDatabaseSchema = cohortSchema,
                  cohortTableNames = cohortTableNames,
                  cohortDefinitionSet = cohortSet) 

```

How many entries are in each cohort? 

```{r}

renderTranslateQuerySql(
  connection,
  "select cohort_definition_id, 
     count(*)
   from @cohortSchema.@cohortTableName
   group by cohort_definition_id",
  cohortSchema = cohortSchema,
  cohortTableName = cohortTableName) |>
  niceTable()

```

# Incidence rate calculation

```{r output=FALSE, message=FALSE, warning=FALSE, results='hide'}

t1 <- createCohortRef(id = 1, name = "Lisinopril cohort")

o1 <- createOutcomeDef(id = 1, name = "Angioedema outcome", cohortId = 2)

tar1 <- createTimeAtRiskDef(id = 1, 
                            startWith = "start",
                            endWith = "end")

analysis1 <- createIncidenceAnalysis(
  targets = c(t1$id), 
  outcomes = c(o1$id),
  tars = c(tar1$id)
)

irDesign <- createIncidenceDesign(
  targetDefs = list(t1),
  outcomeDefs = list(o1),
  tars = list(tar1),
  analysisList = list(analysis1)
)

buildOptions <- buildOptions(
  cohortTable = paste0(cohortSchema, ".", cohortTableName),
  cdmDatabaseSchema = cdmSchema,
  sourceName = "myCdm",
  refId = 1
)

incidenceResults <- executeAnalysis(connectionDetails = connectionDetails,
                                    incidenceDesign = irDesign,
                                    buildOptions = buildOptions)

```

# Results

```{r message=FALSE, warning=FALSE}

sprintf("The incidence rate of angioedema within 1 year after initial lisinopril exposure was %.01f%% (%s/%s)",
        incidenceResults$incidence_summary$INCIDENCE_PROPORTION_P100P,
        incidenceResults$incidence_summary$OUTCOMES,
        incidenceResults$incidence_summary$PERSONS_AT_RISK
)

```